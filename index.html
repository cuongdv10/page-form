<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªçn Fanpage ƒë·ªÉ ƒëƒÉng b√†i</title>
    <style>
        /* C√°c ki·ªÉu CSS cho giao di·ªán */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .search-box {
            margin-bottom: 20px;
        }
        .search-box input {
            width: 100%;
            padding: 8px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .checkbox-item input {
            margin-right: 10px;
        }
        .btn-submit {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        .btn-submit:hover {
            background-color: #0056b3;
        }
        .message-box {
            text-align: center;
            margin-top: 10px;
            color: red;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="logo">
        <img src="https://tocnoi.vn/wp-content/uploads/2023/09/1-e1695052909825.png" alt="Logo" width="200">
    </div>

    <h3>üìù Ch·ªçn c√°c Fanpage ƒë·ªÉ ƒëƒÉng b√†i</h3>

    <form id="form">
        <input type="hidden" id="resumeUrl" value="{{resumeUrl}}" />
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="T√¨m fanpage..." />
        </div>

        <div id="pageContainer"></div>
        
        <button type="submit" class="btn-submit">‚úÖ G·ª≠i th√¥ng tin</button>
    </form>

    <div id="messageBox" class="message-box"></div>
</div>

<script>
    // Khai b√°o API URL
    const apiUrl = "https://script.google.com/macros/s/AKfycbztNHrxAi2Gi5yyEYeES1iVbkZhKn6zTXuyepF1nSXfZDe2ntqn_i-65WXEnEwqvu9S/exec";

    // L·∫•y resumeUrl t·ª´ URL
    const params = new URLSearchParams(window.location.search);
    const resumeUrl = params.get("resumeUrl");

    // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ resumeUrl
    if (!resumeUrl) {
        alert("Kh√¥ng c√≥ resumeUrl. Vui l√≤ng ki·ªÉm tra l·∫°i URL.");
    }

    // G·ª≠i y√™u c·∫ßu ƒë·∫øn API v√† x·ª≠ l√Ω d·ªØ li·ªáu
    fetch(`${apiUrl}?resumeUrl=${encodeURIComponent(resumeUrl)}`)
        .then(response => response.json())
        .then(data => renderForm(data))
        .catch(error => {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
            document.getElementById("messageBox").innerHTML = "‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu.";
        });

    // H√†m ƒë·ªÉ render danh s√°ch fanpage
    function renderForm(data) {
        const { pages, iconMap } = data;
        const pageContainer = document.getElementById("pageContainer");

        if (!pages || pages.length === 0) {
            pageContainer.innerHTML = "<div style='color: red;'>‚ùå Kh√¥ng c√≥ fanpage n√†o.</div>";
            return;
        }

        const grouped = {};
        pages.forEach(page => {
            if (!grouped[page.platform]) {
                grouped[page.platform] = [];
            }
            grouped[page.platform].push(page);
        });

        for (const platform in grouped) {
            const group = grouped[platform];
            const groupElement = document.createElement('div');
            groupElement.className = 'group';

            const icon = iconMap[platform];
            groupElement.innerHTML = `<h3><img src="${icon}" width="20" /> ${platform}</h3>`;

            group.forEach(page => {
                const pageElement = document.createElement('label');
                pageElement.className = 'checkbox-item';
                pageElement.innerHTML = `
                    <input type="checkbox" name="pages" value="${page.name}|${page.id}">
                    <a href="${page.url}" target="_blank">${page.displayName}</a>
                `;
                groupElement.appendChild(pageElement);
            });

            pageContainer.appendChild(groupElement);
        }

        // Th√™m s·ª± ki·ªán l·ªçc fanpage theo t·ª´ kh√≥a
        document.getElementById("searchInput").addEventListener("input", filterPages);

        // Th√™m s·ª± ki·ªán cho c√°c checkbox
        document.querySelectorAll("input[name='pages']").forEach(checkbox => {
            checkbox.addEventListener("change", updateSelectedPages);
        });
    }

    // H√†m l·ªçc c√°c fanpage theo t·ª´ kh√≥a
    function filterPages(event) {
        const searchText = event.target.value.toLowerCase();
        document.querySelectorAll(".checkbox-item").forEach(item => {
            const pageName = item.innerText.toLowerCase();
            item.style.display = pageName.includes(searchText) ? 'block' : 'none';
        });
    }

    // C·∫≠p nh·∫≠t c√°c checkbox ƒë√£ ch·ªçn
    function updateSelectedPages() {
        document.querySelectorAll(".checkbox-item").forEach(item => {
            const checkbox = item.querySelector("input");
            item.classList.toggle("selected", checkbox.checked);
        });
    }

    // X·ª≠ l√Ω khi submit form
    document.getElementById("form").addEventListener("submit", function (event) {
        event.preventDefault();

        const selectedPages = Array.from(document.querySelectorAll("input[name='pages']:checked")).map(cb => cb.value);

        if (!selectedPages.length) {
            document.getElementById("messageBox").innerHTML = "‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt fanpage.";
            return;
        }

        const data = {
            pages: selectedPages
        };

        // G·ª≠i th√¥ng tin l√™n API resumeUrl
        fetch(resumeUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(() => {
            document.getElementById("messageBox").innerHTML = "‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!";
            setTimeout(() => window.close(), 3000); // ƒê√≥ng c·ª≠a s·ªï sau 3 gi√¢y
        })
        .catch(error => {
            document.getElementById("messageBox").innerHTML = "‚ùå ƒê√£ x·∫£y ra l·ªói khi g·ª≠i d·ªØ li·ªáu.";
        });
    });
</script>

</body>
</html>
